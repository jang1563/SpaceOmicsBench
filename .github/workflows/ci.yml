name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate tasks and README sync
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ── Task schema validation ──────────────────────────────────────────
      - name: Validate task JSON files
        run: python scripts/validate_tasks.py

      # ── README baseline table sync ──────────────────────────────────────
      - name: Check README baseline tables are up to date
        run: |
          python scripts/generate_readme_tables.py --update-readme README.md
          if ! git diff --quiet README.md; then
            echo "ERROR: README baseline tables are out of sync with baseline_results.json"
            echo "Run: python scripts/generate_readme_tables.py --update-readme README.md"
            git diff README.md
            exit 1
          fi
          echo "README baseline tables are in sync."

      # ── Eval harness dry run ────────────────────────────────────────────
      - name: Evaluation harness dry run
        run: python evaluation/eval_harness.py --dry-run

      # ── Python syntax check ─────────────────────────────────────────────
      - name: Syntax check all Python files
        run: |
          find . -name "*.py" \
            -not -path "./.venv/*" \
            -not -path "*/__pycache__/*" \
            | xargs python -m py_compile && echo "All Python files OK"
